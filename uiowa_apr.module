<?php

/**
* Implements hook_permission().
*/
function uiowa_apr_permission() {
  return array(
    'administer uiowa apr' => array(
      'title' => t('Administer University of Iowa APR'),
      'description' => t('Perform administration tasks for the University of Iowa APR module.'),
    ),
  );
}

/**
 * Implements hook_menu().
 */
function uiowa_apr_menu() {
  $items['admin/config/user-interface/uiowa-apr'] = array(
  'title' => 'University of Iowa APR',
  'description' => 'Configuration for the University of Iowa APR module',
  'page callback' => 'drupal_get_form',
  'page arguments' => array('uiowa_apr_config_form'),
  'access arguments' => array('administer uiowa apr'),
  'type' => MENU_NORMAL_ITEM,
  'file' => 'includes/uiowa_apr.admin.inc',
  );

  return $items;
}

/**
 * Implements hook_node_info()
 */
function uiowa_apr_node_info() {
    return array(
        'apr_profile' => array(
            'name' => t('APR Profile'),
            'base' => 'apr_profile',
            'description' => t('Web Profile from APR'),
            'has_title' => TRUE,
            'title_label' => t('HawkID')
         )
    );
}

/**
 * Implement hook_form()
 */
function apr_profile_form($node, $form_state) {
    return node_content_form($node, $form_state);
}


/**
 * Implements hook_field_extra_fields().
 *
 * Naming convention: If the field is agnostic use a generic name.
 * Otherwise prefix the field_name with the entity_type.
 */
function uiowa_apr_field_extra_fields() {
  // Jobs.
  $extra['node']['apr_profile'] = array(
    'display' => array(
      'apr_profile_past_history' => array(
        'label' => t('Past History'),
        'description' => t('Past History.'),
        'weight' => 99,
      ),
    ),
  );
  return $extra;
}

/**
 * Implements hook_node_view().
 */
function uiowa_apr_node_view($node, $view_mode, $langcode) {
  if($node->type == 'apr_profile'){

    if(variable_get('uiowa_apr_api_key') && variable_get('uiowa_apr_population_id')){

      $api_key = variable_get('uiowa_apr_api_key');
      $population_id = variable_get('uiowa_apr_population_id');

      $request = drupal_http_request('https://apps.its.uiowa.edu/facadmin/api/info/?key='.$api_key.'&population_id='.$population_id.'&format=json&hawkid='.$node->title);  
      $person = drupal_json_decode($request->data);    

      dpm($person);

      $extra = uiowa_apr_field_extra_fields();

      $config = field_bundle_settings('node', $node->type);

      foreach ($extra['node'][$node->type]['display'] as $field_name => $field_info) {
        // Check to make sure this field is visible in this view mode.
        if (empty($config['extra_fields']['display'][$field_name][$view_mode]['visible'])) {
          continue;
        }
        
        switch ($field_name) {
          case 'apr_profile_past_history':
            $markup = 'Tester';
            $node->content[$field_name] = array(
              '#prefix' => '<div class="field-name-field-publications"><h3>Publications</h3>',
              '#suffix' => '</div>',
              '#markup' => $markup,
            );
            break;
        }
      }
    }
  }
}