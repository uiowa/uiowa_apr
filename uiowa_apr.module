<?php

use Drupal\node\Entity\NodeType;
use Drupal\Component\Serialization\Json;
use Drupal\Core\Entity\EntityInterface;
use Drupal\Core\Entity\Display\EntityViewDisplayInterface;
use Drupal\Core\Routing\RouteMatchInterface;
use Drupal\views\ViewExecutable;

/**
 * Implements hook_help().
 */
function uiowa_apr_help($route_name, RouteMatchInterface $route_match) {
  switch ($route_name) {
    case 'help.page.uiowa_apr':
      $filepath = dirname(__FILE__) . '/README.md';
      if (file_exists($filepath)) {
        $readme = file_get_contents($filepath);
      }
      else {
        $filepath = dirname(__FILE__) . '/README.txt';
        if (file_exists($filepath)) {
          $readme = file_get_contents($filepath);
        }
      }
      if (!isset($readme)) {
        return NULL;
      }

      /* @var \Drupal\Core\Extension\ModuleHandler $moduleHandler*/
      $moduleHandler = \Drupal::service('module_handler');
      if ($moduleHandler->moduleExists('markdown')) {
        $filters = $moduleHandler->invoke('markdown', 'filter_info');
        $info = $filters['filter_markdown'];

        if (function_exists($info['process callback'])) {
          $output = $info['process callback']($readme, NULL);
        }
        else {
          $output = '<pre>' . $readme . '</pre>';
        }
      }
      else {
        $output = '<pre>' . $readme . '</pre>';
      }

      return $output;
  }
}

/**
 * Implements hook_page_attachments().
 */
function uiowa_apr_page_attachments(array &$attachments) {
  $attachments['#attached']['library'][] = 'uiowa_apr/uiowa_apr_styling';
}

/**
 * {@inheritdoc}
 */
function uiowa_apr_entity_extra_field_info() {
  $extra['node']['apr_profile'] = [
    'display' => [
      'apr_profile_admin_perms' => [
        'label' => t('Appointments'),
        'description' => t('Appointments.'),
        'weight' => 74,
        'visible' => TRUE,
      ],
      'apr_profile_alt_contacts' => [
        'label' => t('Contact Information'),
        'description' => t('Contact Information.'),
        'weight' => 76,
        'visible' => TRUE,
      ],
      'apr_profile_assets' => [
        'label' => t('Assets'),
        'description' => t('Assets.'),
        'weight' => 73,
        'visible' => TRUE,
      ],
      'apr_profile_awardhonor' => [
        'label' => t('Awards and Honors'),
        'description' => t('Awards and Honors.'),
        'weight' => 91,
        'visible' => TRUE,
      ],
      'apr_profile_bio' => [
        'label' => t('Biography'),
        'description' => t('Biography.'),
        'weight' => 80,
        'visible' => TRUE,
      ],
      'apr_profile_centers' => [
        'label' => t('Center, Program and Institute Affiliations'),
        'description' => t('Center, Program and Institute Affiliations.'),
        'weight' => 83,
        'visible' => TRUE,
      ],
      'apr_profile_clinical_narrative' => [
        'label' => t('Clinical Narrative'),
        'description' => t('Clinical Narrative.'),
        'weight' => 87,
        'visible' => TRUE,
      ],
      'apr_profile_congrant' => [
        'label' => t('Grants and Contracts'),
        'description' => t('Grants and Contracts.'),
        'weight' => 98,
        'visible' => TRUE,
      ],
      'apr_profile_creative_works' => [
        'label' => t('Creative Works'),
        'description' => t('Creative Works.'),
        'weight' => 97,
        'visible' => TRUE,
      ],
      'apr_profile_editrev' => [
        'label' => t('Review and Editorial Work'),
        'description' => t('Review and Editorial Work.'),
        'weight' => 94,
        'visible' => TRUE,
      ],
      'apr_profile_education' => [
        'label' => t('Education'),
        'description' => t('Education.'),
        'weight' => 81,
        'visible' => TRUE,
      ],
      'apr_profile_education_postgrad' => [
        'label' => t('Education (Post Graduate)'),
        'description' => t('Education (Post Graduate).'),
        'weight' => 82,
        'visible' => TRUE,
      ],
      'apr_profile_email' => [
        'label' => t('Email'),
        'description' => t('Email.'),
        'weight' => 77,
        'visible' => FALSE,
      ],
      'apr_profile_facdev' => [
        'label' => t('Professional Development Activities'),
        'description' => t('Professional Development Activities.'),
        'weight' => 89,
        'visible' => TRUE,
      ],
      'apr_profile_intellcont' => [
        'label' => t('Publications'),
        'description' => t('Publications.'),
        'weight' => 93,
        'visible' => TRUE,
      ],
      'apr_profile_last_modified' => [
        'label' => t('Last Modified Date'),
        'description' => t('Last Modified Date.'),
        'weight' => 99,
        'visible' => TRUE,
      ],
      'apr_profile_liccert' => [
        'label' => t('Licensures and Certifications'),
        'description' => t('Licensures and Certifications.'),
        'weight' => 88,
        'visible' => TRUE,
      ],
      'apr_profile_member' => [
        'label' => t('Professional Memberships'),
        'description' => t('Professional Memberships.'),
        'weight' => 90,
        'visible' => TRUE,
      ],
      'apr_profile_office_hours' => [
        'label' => t('Office Hours'),
        'description' => t('Office Hours.'),
        'weight' => 79,
        'visible' => TRUE,
      ],
      'apr_profile_pasthist' => [
        'label' => t('Past History'),
        'description' => t('Past History.'),
        'weight' => 75,
        'visible' => TRUE,
      ],
      'apr_profile_perform_exhibit' => [
        'label' => t('Performances and Exhibits'),
        'description' => t('Performances and Exhibits.'),
        'weight' => 96,
        'visible' => TRUE,
      ],
      'apr_profile_present' => [
        'label' => t('Presentations'),
        'description' => t('Presentations.'),
        'weight' => 95,
        'visible' => TRUE,
      ],
      'apr_profile_research_narrative' => [
        'label' => t('Research Narrative'),
        'description' => t('Research Narrative.'),
        'weight' => 86,
        'visible' => TRUE,
      ],
      'apr_profile_resprog' => [
        'label' => t('Areas of Research Interest'),
        'description' => t('Areas of Research Interest.'),
        'weight' => 84,
        'visible' => TRUE,
      ],
      'apr_profile_schteach' => [
        'label' => t('Courses Taught'),
        'description' => t('Courses Taught.'),
        'weight' => 92,
        'visible' => TRUE,
      ],
      'apr_profile_teaching_interests' => [
        'label' => t('Teaching Interests'),
        'description' => t('Teaching Interests.'),
        'weight' => 85,
        'visible' => TRUE,
      ],
      'apr_profile_websites' => [
        'label' => t('Websites'),
        'description' => t('Websites.'),
        'weight' => 78,
        'visible' => TRUE,
      ],
    ],
  ];

  return $extra;
}

/**
 * {@inheritdoc}
 */
function uiowa_apr_node_view(array &$build, EntityInterface $entity, EntityViewDisplayInterface $display, $view_mode) {
  if ($entity->bundle() == 'apr_profile' && $view_mode == 'full') {
    $config = \Drupal::config('uiowa_apr.settings');
    $api_key = $config->get('uiowa_apr.api_key');
    $population_id = $config->get('uiowa_apr.population_id');
    $hawkid = $entity->get('apr_profile_hawkid')->value;

    if (!empty('api_key') && !empty('population_id') && !empty('hawkid')) {
      $source = 'https://apps.its.uiowa.edu/facadmin/api/info/?key='.$api_key.'&population_id='.$population_id.'&format=json&hawkid='.$hawkid;
      $client = \Drupal::httpClient();
      $request = $client->get($source, ['headers' => ['Accept' => 'application/json']]);
      $response = $request->getBody()->getContents();
      $person = json_decode($response, TRUE);
      $extra = uiowa_apr_entity_extra_field_info();

      foreach ($extra['node'][$entity->bundle()]['display'] as $field_name => $field_info) {
        switch ($field_name) {
          case 'apr_profile_admin_perms':
            $data = [];
            if (count($person['pci']['admin_perms']) > 0) {
              foreach ($person['pci']['admin_perms'] as $i => $item) {
                $data[] = $item;
              }
              $build[$field_name] = [
                '#theme' => 'apr_profile_admin_perms',
                '#data' => $data,
              ];
            }
            break;

          case 'apr_profile_alt_contacts':
            $data = [];
            if (count($person['pci']['alt_contacts']) > 0) {
              foreach ($person['pci']['alt_contacts'] as $i => $item) {
                if (!empty($item['type']) && ($item['type'] !== 'Cell' && $item['type'] !== 'Home')) {
                  $data[] = $item;
                }
              }
              $build[$field_name] = [
                '#theme' => 'apr_profile_alt_contacts',
                '#data' => $data,
              ];
            }
            break;

          case 'apr_profile_assets':
            $data = [];
            if (count($person['assets']) > 0) {
              foreach ($person['assets'] as $i => $item) {
                $data[] = $item;
              }
              $build[$field_name] = [
                '#theme' => 'apr_profile_assets',
                '#data' => $data,
              ];
            }
            break;

          case 'apr_profile_awardhonor':
            $data = [];
            if (count($person['awardhonor']) > 0) {
              foreach ($person['awardhonor'] as $i => $item) {
                if (!empty($item['include_on_profile']) && $item['include_on_profile'] == 'Yes') {
                  $data[] = $item;
                }
              }
              $build[$field_name] = [
                '#theme' => 'apr_profile_awardhonor',
                '#data' => $data,
              ];
            }
            break;

          case 'apr_profile_bio':
            $data = [];
            if (!empty($person['pci']['info']['bio'])) {
              $data[] = $person['pci']['info']['bio'];
              $build[$field_name] = [
                '#theme' => 'apr_profile_bio',
                '#data' => $data,
              ];
            }
            break;

          case 'apr_profile_centers':
            $data = [];
            if (count($person['pci']['centers']) > 0) {
              foreach ($person['pci']['centers'] as $i => $item) {
                $data[] = $item;
              }
              $build[$field_name] = [
                '#theme' => 'apr_profile_centers',
                '#data' => $data,
              ];
            }
            break;

          case 'apr_profile_clinical_narrative':
            $data = [];
            if (!empty($person['pci']['info']['clinical_narrative'])) {
              $data[] = $person['pci']['info']['clinical_narrative'];
              $build[$field_name] = [
                '#theme' => 'apr_profile_clinical_narrative',
                '#data' => $data,
              ];
            }
            break;

          case 'apr_profile_congrant':
            $data = [];
            if (count($person['congrant']) > 0) {
              foreach ($person['congrant'] as $i => $item) {
                if (!empty($item['include_on_profile']) && $item['include_on_profile'] == 'Yes') {
                  $data[] = $item;
                }
              }
              $build[$field_name] = [
                '#theme' => 'apr_profile_congrant',
                '#data' => $data,
              ];
            }
            break;

          case 'apr_profile_creative_works':
            $data = [];
            if (count($person['creative_works']) > 0) {
              foreach ($person['creative_works'] as $i => $item) {
                if (!empty($item['include_on_profile']) && $item['include_on_profile'] == 'Yes') {
                  $data[] = $item;
                }
              }
              $build[$field_name] = [
                '#theme' => 'apr_profile_creative_works',
                '#data' => $data,
              ];
            }
            break;

          case 'apr_profile_editrev':
            $data = [];
            if (count($person['editrev']) > 0) {
              foreach ($person['editrev'] as $i => $item) {
                if (!empty($item['include_on_profile']) && $item['include_on_profile'] == 'Yes') {
                  $data[] = $item;
                }
              }
              $build[$field_name] = [
                '#theme' => 'apr_profile_editrev',
                '#data' => $data,
              ];
            }
            break;

          case 'apr_profile_education':
            $data = [];
            if (count($person['education']) > 0) {
              foreach ($person['education'] as $i => $item) {
                if (!empty($item['include_on_profile']) && $item['include_on_profile'] == 'Yes') {
                  $data[] = $item;
                }
              }
              $build[$field_name] = [
                '#theme' => 'apr_profile_education',
                '#data' => $data,
              ];
            }
            break;

          case 'apr_profile_education_postgrad':
            $data = [];
            if (count($person['education_postgrad']) > 0) {
              foreach ($person['education_postgrad'] as $i => $item) {
                if (!empty($item['include_on_profile']) && $item['include_on_profile'] == 'Yes') {
                  $data[] = $item;
                }
              }
              $build[$field_name] = [
                '#theme' => 'apr_profile_education_postgrad',
                '#data' => $data,
              ];
            }
            break;

          case 'apr_profile_email':
            $data = [];
            if (!empty($person['pci']['info']['email'])) {
              $data[] = $person['pci']['info']['email'];
              $build[$field_name] = [
                '#theme' => 'apr_profile_email',
                '#data' => $data,
              ];
            }
            break;

          case 'apr_profile_facdev':
            $data = [];
            if (count($person['facdev']) > 0) {
              foreach ($person['facdev'] as $i => $item) {
                if (!empty($item['include_on_profile']) && $item['include_on_profile'] == 'Yes') {
                  $data[] = $item;
                }
              }
              $build[$field_name] = [
                '#theme' => 'apr_profile_facdev',
                '#data' => $data,
              ];
            }
            break;

          case 'apr_profile_intellcont':
            $data = [];
            if (count($person['intellcont']) > 0) {
              foreach ($person['intellcont'] as $i => $item) {
                if (!empty($item['include_on_profile']) && ($item['include_on_profile'] == 'Top Ten' || $item['include_on_profile'] == 'Show All')) {
                  $data[] = $item;
                }
              }
              $build[$field_name] = [
                '#theme' => 'apr_profile_intellcont',
                '#data' => $data,
              ];
            }
            break;

          case 'apr_profile_last_modified':
            $data = [];
            if (!empty($person['last_modified_date'])) {
              $data[] = $person['last_modified_date'];
              $build[$field_name] = [
                '#theme' => 'apr_profile_last_modified',
                '#data' => $data,
              ];
            }
            break;

          case 'apr_profile_liccert':
            $data = [];
            if (count($person['liccert']) > 0) {
              foreach ($person['liccert'] as $i => $item) {
                if (!empty($item['include_on_profile']) && $item['include_on_profile'] == 'Yes') {
                  $data[] = $item;
                }
              }
              $build[$field_name] = [
                '#theme' => 'apr_profile_liccert',
                '#data' => $data,
              ];
            }
            break;

          case 'apr_profile_member':
            $data = [];
            if (count($person['member']) > 0) {
              foreach ($person['member'] as $i => $item) {
                if (!empty($item['include_on_profile']) && $item['include_on_profile'] == 'Yes') {
                  $data[] = $item;
                }
              }
              $build[$field_name] = [
                '#theme' => 'apr_profile_member',
                '#data' => $data,
              ];
            }
            break;

          case 'apr_profile_office_hours':
            $data = [];
            if (count($person['pci']['office_hours']) > 0) {
              foreach ($person['pci']['office_hours'] as $i => $item) {
                $data[] = $item;
              }
              $build[$field_name] = [
                '#theme' => 'apr_profile_office_hours',
                '#data' => $data,
              ];
            }
            break;

          case 'apr_profile_pasthist':
            $data = [];
            if (count($person['pasthist']) > 0) {
              foreach ($person['pasthist'] as $i => $item) {
                if (!empty($item['include_on_profile']) && $item['include_on_profile'] == 'Yes') {
                  $data[] = $item;
                }
              }
              $build[$field_name] = [
                '#theme' => 'apr_profile_pasthist',
                '#data' => $data,
              ];
            }
            break;

          case 'apr_profile_perform_exhibit':
            $data = [];
            if (count($person['perform_exhibit']) > 0) {
              foreach ($person['perform_exhibit'] as $i => $item) {
                if (!empty($item['include_on_profile']) && $item['include_on_profile'] == 'Yes') {
                  $data[] = $item;
                }
              }
              $build[$field_name] = [
                '#theme' => 'apr_profile_perform_exhibit',
                '#data' => $data,
              ];
            }
            break;

          case 'apr_profile_present':
            $data = [];
            if (count($person['present']) > 0) {
              foreach ($person['present'] as $i => $item) {
                if (!empty($item['include_on_profile']) && $item['include_on_profile'] == 'Yes') {
                  $data[] = $item;
                }
              }
              $build[$field_name] = [
                '#theme' => 'apr_profile_present',
                '#data' => $data,
              ];
            }
            break;

          case 'apr_profile_research_narrative':
            $data = [];
            if (!empty($person['pci']['info']['research_narrative'])) {
              $data[] = $person['pci']['info']['research_narrative'];
              $build[$field_name] = [
                '#theme' => 'apr_profile_research_narrative',
                '#data' => $data,
              ];
            }
            break;

          case 'apr_profile_resprog':
            $data = [];
            if (count($person['resprog']) > 0) {
              foreach ($person['resprog'] as $i => $item) {
                $data[] = $item;
              }
              $build[$field_name] = [
                '#theme' => 'apr_profile_resprog',
                '#data' => $data,
              ];
            }
            break;

          case 'apr_profile_schteach':
            $data = [];
            if (count($person['schteach']) > 0) {
              foreach ($person['schteach'] as $i => $item) {
                if (!empty($item['include_on_profile']) && $item['include_on_profile'] == 'Yes') {
                  $data[] = $item;
                }
              }
              $build[$field_name] = [
                '#theme' => 'apr_profile_schteach',
                '#data' => $data,
              ];
            }
            break;

          case 'apr_profile_teaching_interests':
            $data = [];
            if (!empty($person['pci']['info']['teaching_interests'])) {
              $data[] = $person['pci']['info']['teaching_interests'];
              $build[$field_name] = [
                '#theme' => 'apr_profile_teaching_interests',
                '#data' => $data,
              ];
            }
            break;

          case 'apr_profile_websites':
            $data = [];
            if (count($person['pci']['websites']) > 0) {
              foreach ($person['pci']['websites'] as $i => $item) {
                $data[] = $item;
              }
              $build[$field_name] = [
                '#theme' => 'apr_profile_websites',
                '#data' => $data,
              ];
            }
            break;
        }
      }
    }
  }
}

/**
 * {@inheritdoc}
 */
function uiowa_apr_theme($existing, $type, $theme, $path) {
  $path = drupal_get_path('module', 'uiowa_apr') . '/templates';
  return [
    'apr_profile_admin_perms' => [
      'variables' => [
        'data' => [
          'id' => NULL,
          'hawkid' => NULL,
          'appointment_type' => NULL,
          'college' => NULL,
          'dep' => NULL,
          'division' => NULL,
          'job_code' => NULL,
          'rank' => NULL,
          'person_type' => NULL,
          'title' => NULL,
          'division_url' => NULL,
          'dep_url' => NULL,
          'hire_start_date' => NULL,
          'termination_date' => NULL,
        ],
      ],
    ],
    'apr_profile_alt_contacts' => [
      'variables' => [
        'data' => [
          'id' => NULL,
          'hawkid' => NULL,
          'building' => NULL,
          'room' => NULL,
          'type' => NULL,
          'address' => NULL,
          'city' => NULL,
          'state' => NULL,
          'zip' => NULL,
          'phone' => NULL,
        ],
      ],
    ],
    'apr_profile_assets' => [
      'variables' => [
        'data' => [
          'hawkid' => NULL,
          'uuid' => NULL,
          'profile' => NULL,
          'public_uuid' => NULL,
          'uri' => NULL,
        ],
      ],
    ],
    'apr_profile_awardhonor' => [
      'variables' => [
        'data' => [
          'id' => NULL,
          'start_date' => NULL,
          'end_date' => NULL,
          'name' => NULL,
          'org' => NULL,
          'city' => NULL,
          'state' => NULL,
          'country' => NULL,
          'include_on_profile' => NULL,
        ],
      ],
    ],
    'apr_profile_bio' => [
      'variables' => ['data' => NULL],
    ],
    'apr_profile_centers' => [
      'variables' => [
        'data' => [
          'name' => NULL,
          'url' => NULL,
        ],
      ],
    ],
    'apr_profile_clinical_narrative' => [
      'variables' => ['data' => NULL],
    ],
    'apr_profile_congrant' => [
      'variables' => [
        'data' => [
          'id' => NULL,
          'start_date' => NULL,
          'end_date' => NULL,
          'type' => NULL,
          'status' => NULL,
          'include_on_profile' => NULL,
          'formatted' => NULL,
        ],
      ],
    ],
    'apr_profile_creative_works' => [
      'variables' => [
        'data' => [
          'id' => NULL,
          'start_date' => NULL,
          'end_date' => NULL,
          'type' => NULL,
          'include_on_profile' => NULL,
          'formatted' => NULL,
        ],
      ],
    ],
    'apr_profile_editrev' => [
      'variables' => [
        'data' => [
          'id' => NULL,
          'hawkid' => NULL,
          'start_date' => NULL,
          'end_date' => NULL,
          'title' => NULL,
          'role' => NULL,
          'numhours_yearly' => NULL,
          'include_on_profile' => NULL,
        ],
      ],
    ],
    'apr_profile_education' => [
      'variables' => [
        'data' => [
          'id' => NULL,
          'completed_date' => NULL,
          'deg' => NULL,
          'deg_title' => NULL,
          'major' => NULL,
          'school' => NULL,
          'city' => NULL,
          'state' => NULL,
          'country' => NULL,
          'include_on_profile' => NULL,
        ],
      ],
    ],
    'apr_profile_education_postgrad' => [
      'variables' => [
        'data' => [
          'id' => NULL,
          'start_date' => NULL,
          'end_date' => NULL,
          'deg' => NULL,
          'desc' => NULL,
          'major' => NULL,
          'school' => NULL,
          'city' => NULL,
          'state' => NULL,
          'country' => NULL,
          'include_on_profile' => NULL,
        ],
      ],
    ],
    'apr_profile_email' => [
      'variables' => ['data' => NULL],
    ],
    'apr_profile_facdev' => [
      'variables' => [
        'data' => [
          'id' => NULL,
          'hawkid' => NULL,
          'start_date' => NULL,
          'end_date' => NULL,
          'title' => NULL,
          'purpose' => NULL,
          'org' => NULL,
          'city' => NULL,
          'state' => NULL,
          'country' => NULL,
          'county' => NULL,
          'type' => NULL,
          'type_other' => NULL,
          'desc' => NULL,
          'chours' => NULL,
          'include_on_profile' => NULL,
        ],
      ],
    ],
    'apr_profile_intellcont' => [
      'variables' => [
        'data' => [
          'id' => NULL,
          'start_date' => NULL,
          'intellcont_status' => NULL,
          'contype' => NULL,
          'contype_other' => NULL,
          'weight' => NULL,
          'include_on_profile' => NULL,
          'formatted' => NULL,
        ],
      ],
    ],
    'apr_profile_last_modified' => [
      'variables' => ['data' => NULL],
    ],
    'apr_profile_liccert' => [
      'variables' => [
        'data' => [
          'id' => NULL,
          'start_date' => NULL,
          'end_date' => NULL,
          'certtype' => NULL,
          'include_on_profile' => NULL,
          'formatted' => NULL,
        ],
      ],
    ],
    'apr_profile_member' => [
      'variables' => [
        'data' => [
          'id' => NULL,
          'hawkid' => NULL,
          'start_date' => NULL,
          'end_date' => NULL,
          'org' => NULL,
          'orgabbr' => NULL,
          'scope' => NULL,
          'include_on_profile' => NULL,
        ],
      ],
    ],
    'apr_profile_office_hours' => [
      'variables' => [
        'data' => [
          'id' => NULL,
          'hawkid' => NULL,
          'day' => NULL,
          'from' => NULL,
          'to' => NULL,
        ],
      ],
    ],
    'apr_profile_pasthist' => [
      'variables' => [
        'data' => [
          'id' => NULL,
          'start_date' => NULL,
          'end_date' => NULL,
          'title' => NULL,
          'org' => NULL,
          'dep' => NULL,
          'city' => NULL,
          'state' => NULL,
          'include_on_profile' => NULL,
          'profile_order' => NULL,
        ],
      ],
    ],
    'apr_profile_perform_exhibit' => [
      'variables' => [
        'data' => [
          'id' => NULL,
          'start_date' => NULL,
          'end_date' => NULL,
          'exhibit_type' => NULL,
          'include_on_profile' => NULL,
          'formatted' => NULL,
        ],
      ],
    ],
    'apr_profile_present' => [
      'variables' => [
        'data' => [
          'id' => NULL,
          'start_date' => NULL,
          'end_date' => NULL,
          'type' => NULL,
          'include_on_profile' => NULL,
          'formatted' => NULL,
        ],
      ],
    ],
    'apr_profile_research_narrative' => [
      'variables' => ['data' => NULL],
    ],
    'apr_profile_resprog' => [
      'variables' => [
        'data' => [
          'id' => NULL,
          'hawkid' => NULL,
          'title' => NULL,
          'category' => NULL,
          'desc' => NULL,
        ],
      ],
    ],
    'apr_profile_schteach' => [
      'variables' => [
        'data' => [
          'term' => NULL,
          'year' => NULL,
          'title' => NULL,
          'coursepre' => NULL,
          'coursenum' => NULL,
          'include_on_profile' => NULL,
        ],
      ],
    ],
    'apr_profile_teaching_interests' => [
      'variables' => ['data' => NULL],
    ],
    'apr_profile_websites' => [
      'variables' => [
        'data' => [
          'id' => NULL,
          'hawkid' => NULL,
          'desc' => NULL,
          'url' => NULL,
          'type' => NULL,
        ],
      ],
    ],
  ];
}

/**
 * Implements hook_views_pre_render().
 * Display only one result in views, do not display duplicates
 */
function uiowa_apr_views_pre_render(ViewExecutable $view) {
  if ($view->id() == 'apr_profiles') {
    $unique_nids = [];
    $new_result = [];

    foreach ($view->result as $row) {
        if (!in_array($row->nid, $unique_nids)) {
          $new_result[] = $row;
          $unique_nids[] = $row->nid;
        }
    }

    $view->result = $new_result;
  }

  /* Hide the exposed filter is the view is empty */
/*
  if ($view->id() == 'apr_profiles') {
    if (empty($view->result) && empty($view->getExposedInput())) {
      $view->exposed_widgets = NULL;
    }
  }
*/
}
